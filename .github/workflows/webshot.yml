name: Webshot & Quote Extractor (v3.1)

on:
  workflow_dispatch:
    inputs:
      input_file:
        description: "Path to the URL list file (urls.csv or urls.txt)"
        required: false
        default: "urls.csv"
      out_dir:
        description: "Output base directory in repo"
        required: false
        default: "webshots"
      viewport:
        description: "Viewport WxH"
        required: false
        default: "1366x768"
      delay_ms:
        description: "Extra delay before shot (ms)"
        required: false
        default: "2000"
      commit_outputs:
        description: "Commit outputs to repo (yes/no)"
        required: false
        default: "yes"

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Playwright browsers
        run: |
          python -m playwright install --with-deps chromium

      - name: Ensure output base dir exists
        run: |
          mkdir -p "${{ github.event.inputs.out_dir || 'webshots' }}"

      - name: Run extractor
        env:
          INPUT_FILE: ${{ github.event.inputs.input_file }}
          OUT_DIR: ${{ github.event.inputs.out_dir }}
          VIEWPORT: ${{ github.event.inputs.viewport }}
          DELAY_MS: ${{ github.event.inputs.delay_ms }}
        run: |
          set -euxo pipefail
          python webshot_extract.py             --input "${INPUT_FILE:-urls.csv}"             --out   "${OUT_DIR:-webshots}"             --viewport "${VIEWPORT:-1366x768}"             --delay "${DELAY_MS:-2000}"
          echo "Extractor finished"

      - name: List outputs (debug)
        run: |
          echo "=== TREE ==="
          ls -R "${{ github.event.inputs.out_dir || 'webshots' }}" || true
          echo "==========="

      - name: Commit outputs (optional)
        if: ${{ github.event.inputs.commit_outputs == 'yes' }}
        run: |
          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"
          git add ${{ github.event.inputs.out_dir || 'webshots' }} || true
          if ! git diff --cached --quiet; then
            git commit -m "webshot v3.1 outputs: ${GITHUB_RUN_ID}" || true
            git pull --rebase || true
            git push || true
          else
            echo "No changes to commit"
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: webshot-v3_1-${{ github.run_id }}
          path: ${{ github.event.inputs.out_dir || 'webshots' }}
          if-no-files-found: warn
